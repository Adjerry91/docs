import Link from '@docusaurus/Link';
import useBaseUrl from '@docusaurus/useBaseUrl';
import {TroubleShootTable} from '@site/src/components/Utils.tsx'

# SRanipal (VIVE)

## Summary

SRanipal is the runtime used to interface with the Vive Facial Tracker and other Vive eye / face tracking related hardware on Windows PCs.
SRanipal is **required software** for the Vive Facial Tracker and Vive Pro Eye but **NOT REQUIRED** for running VRCFT if you are not using Vive hardware.

:::info
Trivia Fact: SRanipal stands for "*Super Runtime Animation Pal*"
:::

## Hardware

The SRanipal Module is only compatible with the following hardware

| Headset | Eye Tracking | Facial Tracking | Minimum SRanipal Version |
| ---------------------------------- | -------- | --------- | --------- |
| Vive Pro Eye                       | `‚úÖ` Yes | `‚ùå` No  | `1.3.0.0` |
| Droolon F1                         | `‚úÖ` Yes | `‚ùå` No  | `1.3.0.0` |
| Vive Facial Tracker                | `‚ùå` No  | `‚úÖ` Yes | `1.3.0.0` |
| Vive Focus 3 (with both add-ons)   | `‚úÖ` Yes | `‚úÖ` Yes | `1.3.6.8` |

## Set-up

To use the SRanipal Module, you'll need a compatible headset and the SRanipal Runtime from Vive installed.
Which version of SRanipal you install is very important!
Please read carefully to avoid any issues.

There are three methods of installing SRanipal, in order of most to least recommended:

1. Use the installer of SRanipal v1.3.1.1
2. Use the v1.3.6.5 zip of SRanipal in the VRCFT Discord #file-share channel
3. Install Vive Console (avaliable on Steam or Vive website)

:::warning
Version 1.3.2.0 is known to unnecessarily hog computer resources. We generally not recommend using v1.3.2.0.
:::

:::warning
Versions of SRanipal including and after 1.3.6.10 (any version currently packaged with Vive Console) will **only work with a Vive Pro series headset connected to the computer**.
:::

:::warning
Versions of SRanipal including and after **1.3.6.5** will generate *an unreasonable* amount of spam in it's EyeModule log when eye tracking is initialized.
Do not leave VRCFaceTracking unnecessarily running in the background for long periods of time as the size of the log file can easily get into the range of
tens to hundreds **gigabytes** if left unchecked.
Until this is resolved, we recommend users use older versions of SRanipal if possible.
:::

The recommended version to use as of now (May 2023):

- If you aren't using a Focus 3 (basically everyone), should use the [v1.3.1.1 installer](#installing-via-v1311-installer)
- Focus 3 users must use the Vive Console version of SRanipal

### Installing Via v1.3.1.1 Installer

1. Download the [SRanipal v1.3.1.1 installer](https://drive.google.com/drive/folders/1hU1tvOiTHQbT-Ad-wBJ8II8uXkQ8bvvh?usp=share_link)
2. Run the installer and complete the installation process

:::info
The installer for v1.3.1.1 has a known failure point during installation: **Error 1001**. It is not entirely clear why it happens.
All we know is that it is a meaningless, "VIVE Moment" kind of error.
:::

<div style={{
    width: '50%',
    height: 'auto',
    margin: 'auto',
    display: 'block'
}}>
    <img src={require("../img/vive/sranipal/vive_installer_error_1001.png").default} alt="sranipal error 1001" />
</div>

In case you encounter this error when attempting to install SRanipal v1.3.1.1, you can try working around it:

<details>
  <summary>Working around Error 1001</summary>
  <div>
    <div>
      <b>KEEP THE INSTALLER WINDOW OPEN ON THE ERROR BEFORE CONTINUING</b>
      <ol>
        <li>Copy the installed SRanipal directory from <code>C:\Program Files\Vive\SRanipal</code> into a temporary directory somewhere else</li>
        <li>Let the installer continue to fail and "uninstall" SRanipal </li>
        <li>Copy SRanipal back from the temporary directory into the proper installation directory</li>
        <li>Run the following command in a Windows terminal opened in the SRanipal install directory: <code>New-Service -Name "SRanipalService" -BinaryPathName "SRanipalService.exe" -StartupType Automatic -Description "SRanipal Service"</code></li>
      </ol>
      Or, just pull computer power so the installer doesn't uninstall anything. Use SRanipal normally after restarting the computer.
    </div>
  </div>
</details>

Alternatively, you can

1. Attempt [uninstalling sranipal](#uninstalling-sranipal) and seeing if it installs correctly after
2. (Last resort!) Install SRanipal via one of the other options (Vive Console or the v1.3.6.5 zip)

### Installing Via v1.3.6.5 .zip

:::note
   Using SRanipal from this zip will not automatically install the SRanipalService, which means starting VRCFaceTracking or any other
   program that uses SRanipal **will not start SRanipal automatically**.
   Make sure to **run sr_runtime.exe first** before using VRCFaceTracking or install the SRanipalService manually / use it from the 1.3.1.1 installer.
:::

1. Download the [SRanipal v1.3.6.5 .zip (Discord Link)](https://discord.com/channels/849300336128032789/915075185328152606/1017600042837753906)
2. Unzip the folder and run ``DriverInstaller.msi``

An alternative installation method would be to run the v1.3.1.1 (or v.1.3.2.0) installer, then copy the contents of the v1.3.6.5 version into the older version's installation directory.
This will keep the service intact while using the newer runtime.

### Installing Via Vive Console

1. It is recommended to install [Vive Console via Steam](https://store.steampowered.com/app/1635730/VIVE_Console_for_SteamVR/)
2. After install, run Vive Console once to let it's internal installers run. You never need to run Vive Console again.
    - Vive Console does take up a lot of space (~1.6Gb), so copying the SRanipal folder (``Steam\steamapps\common\VIVEDriver\App\SRanipal``) out , then uninstalling Vive Console is another avenue. Note that this will require manual registration of the SRanipal service and drivers as the Vive Console uninstall will remove them.

## Using SRanipal

Once SRanipal initializes, the tray icon can show a few possible states indicating the status of SRanipal-compatible hardware connected to the computer.
You can find the Windows tray in your Windows taskbar, close to the clock. You might need to click the little right-pointing arrow to show hidden icons to find
the little SRanipal robot icon.

| Area/ Color        | Eye                                                             | Mouth                                                              |
|--------------------|-----------------------------------------------------------------|--------------------------------------------------------------------|
| `‚¨õ` Black (Dark) | Eye tracker (VPE) was not detected                              | Vive Facial Tracker was not detected                               |
| `üüß` Orange       | Eye tracker (VPE) was detected, currently uninitialized         | Vive Facial Tracker was detected, currently uninitialized          |
| `üü©` Green        | Eye tracker (VPE) was initialized and sending eye tracking data | Vive Facial Tracker was initialized and sending face tracking data |
| `üü™` Purple       | Eye tracker (Focus 3) successful connection                     | Face Tracker (Focus 3) successful connection                       |
| `üü¶` Blue         | Some uninitialized state in 1.3.6.10+ versions                  | Some uninitialized state in 1.3.6.10+ versions                     |

To actually use your Vive hardware with VRChat, you will need to use the SRanipal VRCFT Module with the VRCFaceTracking software.
For more information on how to install the VRCFT Module, see the <Link to={useBaseUrl('docs/vrcft-software/vrcft#module-registry')}>Module Registry</Link> section.

Assuming there are no connection issues with the hardware, the connection hardware components (eye, face, or both) should be initialized by VRCFT after a few seconds.
Note that upon first initlization of the Vive Facial Tracker and Vive Pro Eye in SteamVR it may prompt you for permission.
Make sure to accept to the user agreement.

### Calibrating Eye Tracking

After installing SRanipal, a new app will be added to your SteamVR dashboard called "Vive Pro Eye Calibration". This app is **only for Vive Pro Eye** (and the Droolon F1 module).
The Vive Focus 3 eye tracker is calibrated with the calibration sequence accessible from the standalone settings menu.
Eye tracking calibration is not required to be performed frequently, but should be done after initial SRanipal software installation, after a change to the headset (i.e. change the facial interface), or when switching the headset between users.
Note that the calibration is only for gaze tracking.

Start calibration by making sure "Use Eye Tracking" is enabled, then hitting the "Calibrate" button in the app. Follow the in-app instructions to finish calibrating the eye gaze tracking.  

## Uninstalling SRanipal

To uninstall SRanipal, uninstall Vive Console (if installed that route) or run the SRanipal installer .exe (v1.3.1.1) and select the "uninstall" option.

In case SRanipal seems to have some issues (especially after having mixed different versions) and the SRanipal installer seems to be unable to uninstall SRanipal, follow [these instructions from Vive Admin C.T.](https://forum.htc.com/topic/5642-sranipal-getting-started-steps/?do=findComment&comment=46845)

## Troubleshooting

These troubleshooting options will only cover SRanipal installation / general issues.
You may find more troubleshooting steps specifically related to your Vive headset/hardware on its documentation respective page.

<details>
  <summary>Error 1001!?!</summary>
  <TroubleShootTable
  cause="Vive software being Vive software">

  Follow the workarounds listed at the [instructions for the 1.3.1.1 installer](#installing-via-v1311-installer).

  </TroubleShootTable>
</details>

<details>
  <summary>SRanipal does not automatically start with VRCFT</summary>
  <TroubleShootTable
  cause="Either you forgot to install the SRanipal module for VRCFT, or SRanipalService.exe is not registered as a Windows service.">

  Make sure the SRanipal module is installed from the Module Registry in VRCFT. Then if SRanipal still does not start with VRCFT,
  try manually registering the SRanipal Service by navigating to the SRanipal install directory and running the following command in a
  Windows terminal opened to that directory: 
  <code>New-Service -Name "SRanipalService" -BinaryPathName "SRanipalService.exe" -StartupType Automatic -Description "SRanipal Service"</code>

  </TroubleShootTable>
</details>


<!-- :::info
If you're having performance issues and are using the Vive Pro Eye and/or the Vive Facial Tracker, try downgrading to SRanipal version 1.3.1.1
::: -->